<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Screen Time Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .child-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .child-btn {
            background: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .child-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .child-btn.active {
            background: #ff6b6b;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .device-list {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .device-item:last-child {
            border-bottom: none;
        }

        .device-name {
            font-weight: 600;
            color: #333;
        }

        .device-time {
            color: #667eea;
            font-weight: 600;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="status-indicator" id="statusIndicator">
        üü¢ System Online
    </div>

    <div class="container">
        <div class="header">
            <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Screen Time Monitor</h1>
            <p>Keeping tabs on digital habits since 2025</p>
        </div>

        <div class="child-selector">
    <button class="child-btn active" onclick="selectChild('emma', this)">üëß Emma (12)</button>
    <button class="child-btn" onclick="selectChild('jake', this)">üë¶ Jake (9)</button>
</div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="todayTime">3h 45m</div>
                <div class="stat-label">Today's Screen Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="weeklyAvg">4h 12m</div>
                <div class="stat-label">Weekly Average</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="mostUsedApp">YouTube</div>
                <div class="stat-label">Most Used App</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="streakDays">3 days</div>
                <div class="stat-label">Under Limit Streak</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">üìä Weekly Screen Time Trend</div>
                <canvas id="weeklyChart"></canvas>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">üì± App Usage Breakdown</div>
                <canvas id="appChart"></canvas>
            </div>
        </div>

        <div class="device-list">
            <div class="chart-title">üì± Device Usage Today</div>
            <div class="device-item">
                <span class="device-name">üì± iPhone</span>
                <span class="device-time">2h 30m</span>
            </div>
            <div class="device-item">
                <span class="device-name">‚åö Apple Watch</span>
                <span class="device-time">45m</span>
            </div>
            <div class="device-item">
                <span class="device-name">üéÆ Nintendo Switch</span>
                <span class="device-time">30m</span>
            </div>
            <div class="device-item">
                <span class="device-name">üì∫ TV</span>
                <span class="device-time">0m</span>
            </div>
        </div>
    </div>

  <script>
        let currentChild = 1; // Start with Emma (ID 1)
        let weeklyChart, appChart;
        let childrenData = {};
        let isInitialized = false;

        // Initialize charts
        function initCharts() {
            // Weekly trend chart
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            weeklyChart = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Screen Time (minutes)',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Math.floor(value / 60) + 'h ' + (value % 60) + 'm';
                                }
                            }
                        }
                    }
                }
            });

            // App usage pie chart
            const appCtx = document.getElementById('appChart').getContext('2d');
            appChart = new Chart(appCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Loading...'],
                    datasets: [{
                        data: [1],
                        backgroundColor: [
                            '#FF6B6B',
                            '#4ECDC4', 
                            '#45B7D1',
                            '#96CEB4',
                            '#FFEAA7',
                            '#DDA0DD',
                            '#98D8C8'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Convert minutes to readable format
        function formatMinutes(minutes) {
            if (!minutes || minutes === 0) return '0m';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours === 0) return `${mins}m`;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}m`;
        }

        // Show loading state
        function showLoadingState() {
            document.getElementById('todayTime').textContent = 'Loading...';
            document.getElementById('weeklyAvg').textContent = 'Loading...';
            document.getElementById('mostUsedApp').textContent = 'Loading...';
            document.getElementById('streakDays').textContent = 'Loading...';
        }

        // Load real data for a child
        async function loadChildData(childId) {
            try {
                console.log(`üìä Loading data for child ${childId}`);
                
                // Load summary data
                const summaryResponse = await fetch(`/api/child/${childId}/summary`);
                const summary = await summaryResponse.json();
                
                // Load weekly data
                const weeklyResponse = await fetch(`/api/child/${childId}/weekly`);
                const weekly = await weeklyResponse.json();
                
                // Load app data
                const appsResponse = await fetch(`/api/child/${childId}/apps`);
                const apps = await appsResponse.json();
                
                // Store the data
                childrenData[childId] = {
                    summary: summary,
                    weekly: weekly.weekly_data || [],
                    apps: apps.app_usage || []
                };
                
                console.log(`‚úÖ Data loaded for child ${childId}:`, childrenData[childId]);
                
                return childrenData[childId];
                
            } catch (error) {
                console.error(`‚ùå Error loading data for child ${childId}:`, error);
                // Fallback to empty data if API fails
                childrenData[childId] = {
                    summary: { today_minutes: 0, weekly_avg_minutes: 0, most_used_app: 'None', session_count: 0 },
                    weekly: [],
                    apps: []
                };
                return childrenData[childId];
            }
        }

        // Update dashboard with current child's data
        function updateDashboard() {
            console.log('üîÑ updateDashboard called for child:', currentChild);
            console.log('üîÑ Available data:', childrenData);
            
            const data = childrenData[currentChild];
            if (!data) {
                console.log('‚ö†Ô∏è No data available for current child', currentChild, ', showing loading state');
                showLoadingState();
                return;
            }
            
            console.log('‚úÖ Updating dashboard with data for child', currentChild, ':', data);
            
            // Update stats cards with explicit logging
            const todayMinutes = data.summary.today_minutes;
            const weeklyAvg = data.summary.weekly_avg_minutes;
            const mostUsedApp = data.summary.most_used_app;
            const sessionCount = data.summary.session_count;
            
            console.log('üìä Stats:', { todayMinutes, weeklyAvg, mostUsedApp, sessionCount });
            
            document.getElementById('todayTime').textContent = formatMinutes(todayMinutes);
            document.getElementById('weeklyAvg').textContent = formatMinutes(weeklyAvg);
            document.getElementById('mostUsedApp').textContent = mostUsedApp || 'None';
            document.getElementById('streakDays').textContent = `${sessionCount} sessions`;
            
            console.log('‚úÖ Stats cards updated successfully');
            
            // Update weekly chart
            if (data.weekly.length > 0) {
                // Prepare weekly data (last 7 days)
                const weeklyMinutes = new Array(7).fill(0);
                const labels = [];
                const today = new Date();
                
                // Generate labels for last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                }
                
                // Fill in actual data
                data.weekly.forEach(day => {
                    const dayDate = new Date(day.date);
                    const dayIndex = Math.floor((today - dayDate) / (1000 * 60 * 60 * 24));
                    if (dayIndex >= 0 && dayIndex < 7) {
                        weeklyMinutes[6 - dayIndex] = day.total_minutes;
                    }
                });
                
                weeklyChart.data.labels = labels;
                weeklyChart.data.datasets[0].data = weeklyMinutes;
            } else {
                // No data available
                weeklyChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0, 0];
            }
            weeklyChart.update();
            
            // Update app chart
            if (data.apps.length > 0) {
                const appNames = data.apps.map(app => app.app_name);
                const appMinutes = data.apps.map(app => app.total_minutes);
                
                appChart.data.labels = appNames;
                appChart.data.datasets[0].data = appMinutes;
            } else {
                appChart.data.labels = ['No data'];
                appChart.data.datasets[0].data = [1];
            }
            appChart.update();
            
            console.log('‚úÖ Dashboard update complete!');
        }

        // Update dashboard for selected child
        async function selectChild(childName, buttonElement) {
            console.log(`üîÑ Switching to child: ${childName}`);
            
            // Map child names to IDs
            const childMap = {
                'emma': 1,
                'jake': 2
            };
            
            const childId = childMap[childName];
            if (!childId) {
                console.error('‚ùå Invalid child name:', childName);
                return;
            }
            
            currentChild = childId;
            
            // Update button states immediately
            document.querySelectorAll('.child-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
            
            // Show loading state while fetching data
            showLoadingState();
            
            // Load data if not cached, then update dashboard
            if (!childrenData[childId]) {
                console.log(`üì° Loading fresh data for child ${childId}`);
                await loadChildData(childId);
            } else {
                console.log(`‚úÖ Using cached data for child ${childId}`);
            }
            
            // Update the dashboard
            updateDashboard();
        }

        // Check server status
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                document.getElementById('statusIndicator').innerHTML = 'üü¢ System Online';
                document.getElementById('statusIndicator').style.background = '#4CAF50';
            } catch (error) {
                document.getElementById('statusIndicator').innerHTML = 'üî¥ System Offline';
                document.getElementById('statusIndicator').style.background = '#f44336';
            }
        }

        // Load all children data from API
        async function loadAllChildrenData() {
            try {
                console.log('üë∂ Loading children list...');
                const response = await fetch('/api/children');
                const data = await response.json();
                console.log('‚úÖ Children list loaded:', data);
                
                // Load data for each child
                if (data.children && data.children.length > 0) {
                    console.log('üìä Loading screen time data for all children...');
                    
                    // Load Emma first (she's the default)
                    await loadChildData(1);
                    console.log('‚úÖ Emma data loaded, updating dashboard...');
                    
                    // Set current child and update dashboard immediately
                    currentChild = 1;
                    updateDashboard();
                    
                    // Make sure Emma button is active
                    document.querySelectorAll('.child-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent.toLowerCase().includes('emma')) {
                            btn.classList.add('active');
                        }
                    });
                    
                    // Then load Jake in the background
                    if (data.children.length > 1) {
                        await loadChildData(2);
                        console.log('‚úÖ Jake data loaded');
                    }
                    
                    console.log('‚úÖ All data loaded and dashboard initialized');
                    isInitialized = true;
                }
            } catch (error) {
                console.error('‚ùå Error loading children data:', error);
                // Show error state instead of loading forever
                document.getElementById('todayTime').textContent = 'Error';
                document.getElementById('weeklyAvg').textContent = 'Error';
                document.getElementById('mostUsedApp').textContent = 'Error';
                document.getElementById('streakDays').textContent = 'Error';
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Family Screen Time Dashboard');
            
            // Show loading state initially
            showLoadingState();
            
            initCharts();
            checkServerStatus();
            loadAllChildrenData();
            
            // Check status every 30 seconds
            setInterval(checkServerStatus, 30000);
            
            // Refresh data every 5 minutes
            setInterval(() => {
                if (isInitialized) {
                    loadAllChildrenData();
                }
            }, 5 * 60 * 1000);
        });
    </script>

</body>
</html>